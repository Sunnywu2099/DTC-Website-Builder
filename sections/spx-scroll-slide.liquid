<style>
    .index-page-fifth {
        width: 100%;
        position: relative;
        height: {{ section.blocks.size }}00vh;
    }
    .index-page-fifth .index-page-slide-box {
        width: 100%;
        height: 100vh;
        position: sticky;
        left: 0;
        top: 0;
        z-index: 1;
        overflow:hidden;
    }
    .scroll-slide-absolute-item{
        position: absolute;
        left: 0;
        top: 0;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: all .5s linear;
        z-index: 1;
    }
    .scroll-slide-absolute-item.show{
        opacity: 1;
        z-index: 2;
    }
    .index-page-fifth .index-page-slide-backdrop{
        height: auto;
        z-index: 3;
        opacity: 1;
        padding-top: var(--header-height);
    }
    .index-page-fifth .index-page-slide-backdrop .product-text{
        font-weight: 400;
        font-size: 24px;
        line-height: 1.5;
        text-align: center;
    }
    .index-page-fifth .index-page-slide-backdrop .product-title{
        font-weight: 700;
        font-size: 48px;
        line-height: 1.25;
        text-align: center;
        color: #000;
    }
    .index-page-fifth .index-page-slide-backdrop .station-menus {
        width: 960px;
        margin: 4% auto 0;
    }
    .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu{
        font-weight: 400;
        line-height: 1.2;
        color: #9f9f9f;
        padding-bottom: 16px;
        transition: all .5s;
        cursor: pointer;
        width: max-content;
    }
    .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu.selected{
        font-weight: 700;
        font-size: 32px;
        color: #683df5;
    }
    .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu .sub{
        font-size: 0.6em;
        line-height: 1.2;
    }
    .scroll-slide-absolute-item .index-page-content{
        width: 960px;
        margin: 37.5% auto 0;
        position: relative;
        z-index: 5;
    }
    .scroll-slide-absolute-item .product-desc{
        font-weight: 400;
        font-size: 0.8em;
        line-height: 1.5;
        text-align: left;
        color: #707070;
        width: 528px;
        word-break: break-word;
    }
    .scroll-slide-absolute-item .fifth-rows{
        padding-top: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
    }
    .scroll-slide-absolute-item .fifth-rows .product-question{
        font-size: 0.8em;
        font-weight: 700;
        color: #683df5;
        line-height: 1.2;
    }
    .scroll-slide-absolute-item .fifth-rows .buy-now{
        display: flex;
        justify-content: center;
        align-items: center;
        background: #6f4cf1;
        color: #fff;
        position: relative;
        border-radius: 24px;
        font-size: 13px;
        padding: 4px 16px;
    }
    .scroll-slide-absolute-item .fifth-rows .buy-now .icon{
        display: block;
        position: relative;
        width: 13px;
        height: 13px;
        margin-left: 4.8px;
    }
    .scroll-slide-absolute-item .fifth-rows .buy-now .icon:before{
        content: "";
        display: block;
        border: 5px solid transparent;
        border-left-width: 7px;
        border-left-color: #fff;
        position: absolute;
        top: 50%;
        left: 4px;
        transform: translateY(-50%);
        border-radius: 2px;
    }
    .scroll-slide-absolute-item .product-remark{
        font-weight: 400;
        font-size: 12px;
        line-height: 1.5;
        color: #707070;
    }
    .scroll-slide-absolute-item .product-img{
        display:block;
        width: 100%;
        height: 100vh;
        object-fit: cover;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 3;
    }
    .scroll-slide-absolute-item .product-video{
        background-color: #e8f0f5;
    }
    .scroll-slide-absolute-item .product-video .video-warp{
        width: 960px;
        margin: 13% auto 0;
        display: flex;
        justify-content: flex-end;
    }
    .scroll-slide-absolute-item .product-video .screen-video{
        width: 416px;
        height: 416px;
        margin-right: 32px;
        object-fit: contain;
    }
    .shopify-new-index .mobile-done {
        display: none;
    }
    @media screen and (max-width: 1440px){
        .index-page-fifth .index-page-slide-backdrop .product-text{
            font-size: 20px;
        }
        .index-page-fifth .index-page-slide-backdrop .product-title{
            font-size: 40px;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu{
            font-size: 18px;
            padding-bottom: 12px;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu.selected{
            font-size: 26px;
        }
    }
    @media screen and (max-width: 1200px){
        .index-page-fifth .index-page-slide-backdrop{
            padding-top: calc(var(--header-height) + 30px);
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus{
            margin: 5% auto 0;
        }
        .scroll-slide-absolute-item .index-page-content{
            margin: 48% auto 0;
        }
        .scroll-slide-absolute-item .product-video .video-warp{
            margin: 19% auto 0;
        }
        .scroll-slide-absolute-item .fifth-rows{
            padding-top: 4px;
        }
    }
    @media screen and (max-width:991px){
        .shopify-new-index .pc-done {
            display: none;
        }
        .shopify-new-index .mobile-done {
            display: block;
        }
        .index-page-fifth .index-page-slide-backdrop{
            padding-top: calc(var(--header-height) + 20px);
        }
        .index-page-fifth .index-page-slide-backdrop .product-title{
            font-size: 36px;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus,.scroll-slide-absolute-item .index-page-content,.scroll-slide-absolute-item .product-video .video-warp{
            width:90%;
        }
        .scroll-slide-absolute-item .index-page-content{
            margin: 64% auto 0; 
        }
        .scroll-slide-absolute-item .product-video .video-warp{
            margin: 82% auto 0;
            justify-content:center;
        }
        .scroll-slide-absolute-item .product-video .screen-video{
            margin-right:0;
        }
    }   
    @media screen and (max-width:751px){
        .index-page-fifth .index-page-slide-backdrop .product-text{
            font-size: 16px;
        }
        .index-page-fifth .index-page-slide-backdrop .product-title {
            font-size: 24px;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu {
            font-size: 14px;
            padding-bottom: 8px;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu .sub{
            font-size: 0.7em;
        }
        .index-page-fifth .index-page-slide-backdrop .station-menus .station-menu.selected {
            font-size: 20px;
        }
        .scroll-slide-absolute-item .index-page-content{
            margin: 84% auto 0;
        }
        .scroll-slide-absolute-item .product-desc{
            width:100%;
            font-size: 14px;
        }
        .scroll-slide-absolute-item .product-video .video-warp{
            position:relative;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        .scroll-slide-absolute-item .product-video .screen-video{
            width: 80vw;
            height: 80vw;
            position:absolute;
            bottom:4%;
        }
    }
    @media screen and (max-width:400px){
        .index-page-fifth .index-page-slide-backdrop{
            padding-top:var(--header-height);
        }
        .scroll-slide-absolute-item .fifth-rows{
            gap: 8px;
        }
        .scroll-slide-absolute-item .fifth-rows .buy-now{
            font-size: 12px;
            padding: 2px 10px;
        }
        .scroll-slide-absolute-item .fifth-rows .buy-now .icon{
            margin-left: 2.8px;
        }
        .scroll-slide-absolute-item .index-page-content {
            margin: 88% auto 0;
        }
    }
</style>

<div class="index-page-fifth section-{{ section.id }}" node-name="fifthPage">
  <div class="index-page-slide-box">
    <div class="scroll-slide-absolute-item index-page-slide-backdrop">
      <div class="product-text text-center">
        <span class="text-gradient">{{ section.settings.title1 }}</span>
      </div>
      <div class="product-title text-center">{{ section.settings.title2 }}</div>
      <div class="station-menus" node-name="fifthMenus">
        {% for block in section.blocks %}
            <div node-name="fifthMenu" data-key="{{ forloop.index0 }}" class="station-menu {% if forloop.first %}selected{% endif %}">
                {{ block.settings.menu }}
                {% if block.settings.menu_sub != blank %}
                    <span class="sub" data-key="{{ forloop.index0 }}">{{ block.settings.menu_sub }}</span>
                {% endif %}
            </div>
        {% endfor %}
      </div>
    </div>

    {% for block in section.blocks %}
        <div node-name="fifthSlide" class="scroll-slide-absolute-item index-page-slide-{{ forloop.index }} {% if forloop.first %}show{% endif %}">
            <div class="index-page-content">
                <div class="product-desc">
                    {{ block.settings.menu_desc }}
                </div>
                {% if block.settings.menu_remark1 != blank or block.settings.menu_btn != blank %}
                    <div class="fifth-rows">
                        {% if block.settings.menu_remark1 != blank %}
                            <div class="product-question">{{ block.settings.menu_remark1 }}</div>
                        {% endif %}
                        {% if block.settings.menu_btn != blank %}
                            <a href="{{ block.settings.menu_btn_link }}" class="buy-now">
                                {{- block.settings.menu_btn -}}
                                <i class="icon"></i>
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
                {% if block.settings.menu_remark2 != blank %}
                    <div class="product-remark">{{ block.settings.menu_remark2 }}</div>
                {% endif %}
            </div>
            {% if block.settings.enable_image %}
                {{ block.settings.menu_pc_backdrop_url | image_url: width: '1920x' | image_tag: class: 'product-img pc-done', loading: 'lazy' }}
                {{ block.settings.menu_mb_backdrop_url | image_url: width: '750x' | image_tag: class: 'product-img mobile-done', loading: 'lazy' }}
            {% else %}
                <div class="product-video product-img">
                    <div class="video-warp">
                        <video node-name="pcVideo" class="screen-video pc-done" src="{{ block.settings.menu_pc_video_url }}" muted loop playsinline webkit-playsinline preload="metadata"></video>
                        <video node-name="mobileVideo" class="screen-video mobile-done" src="{{ block.settings.menu_mb_video_url }}" muted loop playsinline webkit-playsinline preload="metadata"></video>
                    </div>
              </div>
            {% endif %}
        </div>
    {% endfor %}
  </div>
</div>

<script>
    (function() {
        const box = document.getElementById('MainContent');
    
        let isMobile = /android|iphone|ipad|ipod|micromessenger/gi.test(navigator.userAgent.toLocaleLowerCase()) || window.innerWidth <= 1000;
    
        function getNodeList(node) {
    
            var list = Array.prototype.slice.call(node.querySelectorAll('[node-name]'), 0);
            var nodeList = {};
    
            list.forEach(function(el) {
                var name = el.getAttribute('node-name');
    
                if (name in nodeList) {
                    nodeList[name] = [].concat(nodeList[name], el);
                } else {
                    nodeList[name] = el;
                }
            });
    
            return nodeList;
        }
    
        function getOffset(el) {
            {% comment %} console.log('el =>',el) {% endcomment %}
            let box = el.getBoundingClientRect();
            let body = document.body;
            let clientTop = el.clientTop || body.clientTop || 0;
            let clientLeft = el.clientLeft || body.clientLeft || 0;
            let scrollTop = window.scrollY || el.scrollTop;
            let scrollLeft = window.scrollX || el.scrollLeft;
            return {
                top: box.top + scrollTop - clientTop,
                left: box.left + scrollLeft - clientLeft,
                scrollTop,
                scrollLeft
            };
        }
    
        let screenHeight = window.innerHeight;
        let nodeList = getNodeList(box);
        {% comment %} console.log(nodeList); {% endcomment %}
    
        if (!nodeList.fifthMenu) {
            return false;
        }
    
        let offsetMap = {};
    
        document.addEventListener('scroll', function() {
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            runFiveAnime(scrollTop);
            playVideo(scrollTop);
        }, { passive: true });
    
        let _timer = null;
        window.addEventListener('resize', function() {
            clearTimeout(_timer);
            _timer = setTimeout(() => {
                initOffset();
                isMobile = /android|iphone|ipad|ipod|micromessenger/gi.test(navigator.userAgent.toLocaleLowerCase()) || window.innerWidth <= 1000;
            }, 100);
        });
    
        // 初始化偏移量
        function initOffset() {
            offsetMap.five = {
                menus: nodeList.fifthMenus,
                menu: nodeList.fifthMenu,
                slide: nodeList.fifthSlide,
                top: getOffset(nodeList.fifthPage).top,
                height: nodeList.fifthPage.offsetHeight
            };
    
            const videoList = [];
            const list = isMobile ? nodeList.mobileVideo instanceof Array ? nodeList.mobileVideo : [nodeList.mobileVideo] : nodeList.pcVideo instanceof Array ? nodeList.pcVideo : [nodeList.pcVideo];

            list.forEach(node => {
                videoList.push({
                    node,
                    play: false,
                    top: getOffset(node).top
                });
            });
    
            offsetMap.videoList = videoList;
        }
    
        // 播放视频
        function playVideo(scrollTop) {
            const list = offsetMap.videoList;
            {% comment %} console.log("list ====>",list) {% endcomment %}
            if (list && list.length > 0) {
                list.forEach(obj => {
                    if (!obj.play && scrollTop + 200 > obj.top) {
                        obj.node.play();
                        obj.play = true;
                    }
                });
            }
        }
    
        initOffset();
    
        // 获取滑动比例
        function getMoveRate(scrollTop, top, height) {
            return Math.round(Math.min(1, Math.max(0, scrollTop - top) / (height - screenHeight)) * 100);
        }
    
        // 第五屏动画
        let fiveSelect = 0;
    
        nodeList.fifthMenus.addEventListener('click', ev => {
            const height = offsetMap.five.height;
            const top = offsetMap.five.top;
            const mod = height / nodeList.fifthMenus.childElementCount;
            const index = ev.target.dataset.key;
            console.log(ev.target, index);
            if (index) {
                window.scrollTo(0, top + mod * index - (index > 0 ? 10 : 0));
            }
        });
    
        function runFiveAnime(scrollTop) {
            if (!offsetMap.five) {
                return false;
            }
            const obj = offsetMap.five;
            const unit_rate = (100 / nodeList.fifthMenus.childElementCount).toFixed(2);
            const rate = getMoveRate(scrollTop, obj.top, obj.height);
            let select = 0;
            if (rate < unit_rate) {
                select = 0;
            } else if (rate < unit_rate*2) {
                select = 1;
            } else if (rate < unit_rate*3) {
                select = 2;
            } else if (rate < unit_rate*4) {
                select = 3;
            } else if (rate < unit_rate*5) {
                select = 4;
            } else if (rate < unit_rate*6) {
                select = 5;
            } else if (rate < unit_rate*7) {
                select = 6;
            } else {
                select = 7;
            }
    
            if (fiveSelect !== select) {
                obj.menu[fiveSelect].classList.remove('selected');
                obj.menu[select].classList.add('selected');
                obj.slide[fiveSelect].classList.remove('show');
                obj.slide[select].classList.add('show');
                fiveSelect = select;
            }
        }

    })();
    
</script>

{% schema %}
{
  "name": "Index page fifth",
  "class": "shopify-new-index",
  "tag": "section",
  "max_blocks":8,
  "settings": [
    {
      "type": "text",
      "id": "title1",
      "label": "标题一",
      "default": "Automatic Base Station"
    },
    {
      "type": "text",
      "id": "title2",
      "label": "标题二",
      "default": "One Station to Take Care of All"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "slide",
      "settings": [
        {
            "type": "text",
            "id": "menu",
            "label": "名称",
            "default": "Auto Water Exchange"
        },
        {
            "type": "text",
            "id": "menu_sub",
            "label": "名称 下标",
            "default": "(Optional)"
        },
        {
            "type": "richtext",
            "id": "menu_desc",
            "label": "简介",
            "default": "<p>Forget about filling tanks, lugging them around, dumping dirty water, and accidental spills. easy as a washing machine.</p>"
        },
        {
            "type": "text",
            "id": "menu_remark1",
            "label": "名称备注一",
            "default": "Is This System Right for My Home?"
        },
        {
            "type": "text",
            "id": "menu_remark2",
            "label": "名称备注二",
            "default": "Offered Separately as an Accessory"
        },
        {
            "type": "text",
            "id": "menu_btn",
            "label": "按钮名称",
            "default": "Find Out!"
        },
        {
            "type": "text",
            "id": "menu_btn_link",
            "label": "按钮跳转链接",
            "default": "https://us.narwal.com/pages/automatic-water-exchange-system"
        },
        {
            "type":"checkbox",
            "id":"enable_image",
            "label":"使用图片？否则应用影片",
            "default":true
        },
        {
            "label": "PC背景图",
            "type": "image_picker",
            "info": "1920x 请上传5M以内",
            "id": "menu_pc_backdrop_url"
        },
        {
            "label": "H5背景图",
            "type": "image_picker",
            "info": "750x 请上传5M以内",
            "id": "menu_mb_backdrop_url"
        },
        {
            "label": "PC视频",
            "type": "text",
            "info": "请上传5M以内",
            "id": "menu_pc_video_url",
            "default": "https://cdn.shopify.com/videos/c/o/v/ecc752c45c1e4a4e8b79ab40d3640300.mp4"
        },
        {
            "label": "H5视频",
            "type": "text",
            "info": "请上传5M以内",
            "id": "menu_mb_video_url",
            "default": "https://cdn.shopify.com/videos/c/o/v/af475bf3626d412da3938c6752b2ea41.mp4"
        }
      ]
    }
  ],
  "presets": [
    {
        "name": "轮播滚动",
        "blocks": [
        {
            "type": "slide"
        },
        {
            "type": "slide"
        },
        {
            "type": "slide"
        },
        {
            "type": "slide"
        },
        {
            "type": "slide"
        },
        {
            "type": "slide"
        },
        {
            "type": "slide"
        }
        ]
    }
  ]
}
{% endschema %}
